<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Msmahatha Library | Universal Archive</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=Space+Mono:ital,wght@0,400;0,700;1,400&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div id="root"></div>
  <script type="module" src="/src/main.jsx"></script>
</body>
</html>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'display': ['"Archivo Black"', 'sans-serif'],
                        'body': ['"Space Mono"', 'monospace'],
                        'serif': ['"Crimson Text"', 'serif'],
                    },
                    colors: {
                        'neo-black': '#121212',
                        'neo-white': '#fffdf5',
                        'neo-yellow': '#ffeb3b',
                        'neo-pink': '#ff80ab',
                        'neo-blue': '#80d8ff',
                        'neo-green': '#b9f6ca',
                        'neo-orange': '#ff9100',
                        'neo-red': '#ff5252',
                        'neo-purple': '#ea80fc',
                    },
                    boxShadow: {
                        'hard': '6px 6px 0px 0px #121212',
                        'hard-hover': '10px 10px 0px 0px #121212',
                    },
                    borderWidth: { '3': '3px' }
                }
            }
        }
    </script>
    <style>
        /* LAYOUT & SCROLL FIXES */
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { background-color: #fffdf5; color: #121212; }

        /* CUSTOM SCROLLBAR */
        ::-webkit-scrollbar { width: 12px; background: #121212; }
        ::-webkit-scrollbar-thumb { background: #ffeb3b; border: 2px solid #121212; }
        
        /* 3D TILT EFFECT */
        .book-card {
            transition: transform 0.1s ease-out, box-shadow 0.2s ease;
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .book-card:hover { z-index: 50; }
        
        /* CRT EFFECT */
        .crt::before {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 200; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        
        .animate-marquee { animation: marquee 40s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }
        
        /* GATE ANIMATION */
        .gate-panel { transition: transform 1.5s cubic-bezier(0.7, 0, 0.3, 1); }
        .gate-open .gate-left { transform: translateX(-100%); }
        .gate-open .gate-right { transform: translateX(100%); }
        .gate-open { pointer-events: none !important; } /* CRITICAL FIX */

        /* READER THEME */
        .reader-theme-light { background: #fffdf5; color: #121212; }
        
        /* MOBILE TERMINAL */
        @media (max-width: 768px) {
            #terminal-window { height: 80vh; bottom: 0; top: auto; width: 100%; margin: 0; border-bottom: none; }
            #term-toggle { bottom: 1rem; right: 1rem; }
        }
    </style>
</head>
<body class="font-body h-full w-full relative crt">

    <!-- === GATE LAYER === -->
    <div id="gate-container" class="fixed inset-0 z-[100] flex flex-col md:flex-row transition-all duration-1000">
        <div class="gate-panel gate-left w-full md:w-1/2 h-1/2 md:h-full bg-neo-yellow border-b-3 md:border-b-0 md:border-r-3 border-neo-black flex items-center justify-center relative overflow-hidden">
            <div class="absolute inset-0 opacity-10 bg-[radial-gradient(#121212_1px,transparent_1px)] [background-size:20px_20px]"></div>
            <h1 class="font-display text-5xl md:text-7xl text-neo-black z-10 relative text-center leading-tight uppercase px-4">
                MSMAHATHA<br>LIBRARY
            </h1>
        </div>
        <div class="gate-panel gate-right w-full md:w-1/2 h-1/2 md:h-full bg-neo-black flex items-center justify-center relative">
            <div class="absolute inset-0 opacity-20 bg-[repeating-linear-gradient(45deg,#fffdf5_0,#fffdf5_1px,transparent_0,transparent_50%)] [background-size:10px_10px]"></div>
            <div class="text-center z-10">
                <p class="text-neo-white mb-6 text-xl font-bold">/// UNIVERSAL ARCHIVE RESTORED</p>
                <button id="enter-btn" class="bg-neo-pink text-neo-black border-3 border-neo-white px-8 py-4 font-display text-2xl shadow-[6px_6px_0px_0px_#fffdf5] hover:translate-x-1 hover:translate-y-1 hover:shadow-none transition-all pointer-events-auto cursor-pointer">
                    ENTER ARCHIVE()
                </button>
            </div>
        </div>
    </div>

    <!-- === MAIN APP LAYER === -->
    <div id="app-view" class="h-full flex flex-col opacity-0 transition-opacity duration-1000 delay-500 bg-neo-white">
        
        <!-- NAV -->
        <nav class="flex flex-col shrink-0 z-40 border-b-3 border-neo-black">
            <div class="h-16 bg-neo-white flex border-b-3 border-neo-black">
                <div class="bg-neo-black text-neo-white px-6 flex items-center font-display text-2xl tracking-tighter border-r-3 border-neo-black shrink-0 uppercase cursor-pointer hover:bg-neo-pink transition-colors" onclick="location.reload()">
                    MSMAHATHA_
                </div>
                <div class="flex-1 flex items-center px-4 bg-neo-yellow min-w-0 overflow-hidden">
                    <button id="settings-btn" class="mr-4 border-2 border-neo-black p-1 hover:bg-white font-bold text-sm"><i class="fas fa-cog"></i> CONFIG</button>
                    
                    <div class="hidden md:flex space-x-4 border-l-2 border-neo-black pl-4">
                         <button onclick="loadView('stash')" class="font-bold hover:text-neo-red transition-colors">STASH [<span id="stash-count">0</span>]</button>
                         <button onclick="loadView('history')" class="font-bold hover:text-neo-red transition-colors">HISTORY</button>
                    </div>
                </div>
                <div class="flex bg-neo-black text-neo-green border-l-3 border-neo-black whitespace-nowrap">
                     <div id="user-status" class="px-6 flex items-center font-bold text-sm">
                        <span class="animate-pulse mr-2 text-neo-red">●</span> GUEST
                     </div>
                     <button id="nav-login-btn" class="px-6 bg-neo-white text-neo-black border-l-3 border-neo-black font-bold hover:bg-neo-pink transition-colors">
                        LOGIN
                     </button>
                </div>
            </div>
            <!-- Categories -->
            <div class="flex overflow-x-auto no-scrollbar bg-neo-white items-stretch h-12 border-b-3 border-neo-black" id="category-container"></div>
        </nav>

        <!-- MAIN CONTENT (SCROLL FIX: min-h-0) -->
        <main class="flex-1 flex relative overflow-hidden min-h-0">
            <aside class="w-16 border-r-3 border-neo-black bg-grid hidden md:flex flex-col items-center py-8 gap-8 bg-neo-white">
                <div class="vertical-text font-display text-xl rotate-180" style="writing-mode: vertical-rl;">ARCHIVE</div>
                <div class="w-2 h-2 bg-neo-black rounded-full"></div>
                <div class="w-2 h-2 bg-neo-black rounded-full"></div>
            </aside>

            <div id="book-scroll-container" class="flex-1 overflow-y-auto bg-[radial-gradient(#121212_1px,transparent_1px)] [background-size:40px_40px] relative p-6 md:p-10">
                <div id="book-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8 pb-20"></div>
                <div id="load-more-container" class="py-10 flex justify-center hidden">
                    <button id="load-more-btn" class="bg-neo-black text-neo-white font-display text-xl px-8 py-4 border-3 border-neo-white shadow-hard hover:translate-x-1 hover:translate-y-1 transition-all">
                        LOAD_MORE_DATA()
                    </button>
                </div>
                <div id="initial-loader" class="h-64 flex flex-col items-center justify-center hidden">
                     <div class="w-16 h-16 bg-neo-yellow border-3 border-neo-black animate-spin mb-4"></div>
                     <div id="loader-text" class="font-display text-2xl animate-pulse text-center px-4">CONNECTING_MULTIVERSE...</div>
                </div>
            </div>
        </main>

        <!-- FOOTER -->
        <div class="h-10 bg-neo-black text-neo-white border-t-3 border-neo-black overflow-hidden flex items-center shrink-0">
            <div class="animate-marquee whitespace-nowrap font-bold text-xs tracking-widest">
                /// MSMAHATHA UNIVERSAL LIBRARY /// GOOGLE BOOKS + GUTENDEX + OPEN LIBRARY /// SCROLL ENABLED /// SYSTEM STABLE ///
            </div>
        </div>
    </div>

    <!-- === MODALS === -->

    <!-- Reader Modal -->
    <div id="reader-modal" class="fixed inset-0 z-[80] opacity-0 pointer-events-none bg-neo-black/95 backdrop-blur-sm flex flex-col transition-opacity duration-300">
        <div class="bg-neo-yellow border-b-3 border-neo-black p-4 flex justify-between items-center shrink-0 h-16">
            <div class="font-display text-lg truncate max-w-[200px] md:max-w-md" id="reader-title">BOOK_TITLE.EXE</div>
            <div class="flex gap-2 md:gap-4">
                <button id="stash-btn" class="bg-neo-white border-2 border-neo-black px-3 font-bold hover:bg-neo-pink text-xs md:text-sm flex items-center gap-2"><span>♥</span> <span class="hidden md:inline">SAVE</span></button>
                <button onclick="closeReader()" class="bg-neo-black text-neo-white px-4 font-bold hover:bg-neo-red border-2 border-transparent text-xs md:text-sm">[X]</button>
            </div>
        </div>
        <div id="reader-content" class="flex-1 bg-neo-white relative overflow-hidden p-4 md:p-0 reader-theme-light"></div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="fixed inset-0 z-[90] opacity-0 pointer-events-none bg-neo-black/90 flex items-center justify-center p-4">
        <div class="bg-neo-white w-full max-w-md border-3 border-neo-white shadow-[10px_10px_0px_0px_#333] relative p-8">
            <button onclick="closeAuth()" class="absolute -top-5 -right-5 w-10 h-10 bg-neo-red text-neo-white border-3 border-neo-black font-bold">X</button>
            <h2 class="font-display text-2xl mb-4 text-center">IDENTIFY</h2>
            <input type="text" id="auth-username" class="w-full bg-gray-100 border-3 border-neo-black p-3 font-bold mb-4 uppercase" placeholder="CODENAME">
            <button onclick="handleAuthAction()" class="w-full bg-neo-black text-neo-white border-3 border-neo-black py-3 font-display text-xl hover:bg-neo-pink hover:text-neo-black">LOGIN / REGISTER</button>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 z-[90] opacity-0 pointer-events-none bg-neo-black/90 flex items-center justify-center p-4">
         <div class="bg-neo-white w-full max-w-md border-3 border-neo-white shadow-[10px_10px_0px_0px_#333] p-8 relative">
            <button onclick="document.getElementById('settings-modal').classList.remove('active')" class="absolute -top-5 -right-5 w-10 h-10 bg-neo-red text-neo-white border-3 border-neo-black font-bold">X</button>
            <h2 class="font-display text-2xl mb-6 text-center">CONFIG</h2>
            <div class="space-y-6 font-bold">
                <div class="flex justify-between items-center"><label>SOUND_FX</label><button id="toggle-sound" class="px-4 py-2 bg-neo-green border-3 border-neo-black">ON</button></div>
                <div class="flex justify-between items-center"><label>CRT_OVERLAY</label><button id="toggle-crt" class="px-4 py-2 bg-neo-green border-3 border-neo-black">ON</button></div>
            </div>
         </div>
    </div>

    <!-- === TERMINAL === -->
    <button id="term-toggle" class="fixed bottom-14 right-6 md:bottom-16 md:right-10 z-50 bg-neo-black text-neo-green border-3 border-neo-green px-4 py-3 font-bold shadow-hard hover:translate-x-1 hover:translate-y-1 transition-all">
        >_ AI ASSISTANT
    </button>

    <div id="terminal-window" class="fixed inset-0 z-[110] hidden flex items-center justify-center bg-black/50">
        <div class="bg-neo-black w-full max-w-3xl mx-4 border-3 border-neo-white shadow-hard-hover flex flex-col h-[600px]">
            <div class="bg-neo-white text-neo-black p-3 font-bold border-b-3 border-neo-white flex justify-between items-center">
                <span class="font-display tracking-wide">MSMAHATHA_AI // FEDERATED_CORE</span>
                <button id="term-close" class="px-2 hover:bg-neo-pink hover:text-neo-white border-2 border-transparent">X</button>
            </div>
            <!-- Tabs -->
            <div class="flex border-b-3 border-neo-white bg-neo-black">
                <button onclick="setTermMode('console')" id="tab-console" class="flex-1 py-2 font-bold text-neo-black bg-neo-green hover:opacity-90 transition-colors">CONSOLE</button>
                <button onclick="setTermMode('search')" id="tab-search" class="flex-1 py-2 font-bold text-neo-green border-l-3 border-neo-white hover:bg-neo-white hover:text-neo-black transition-colors">SEARCH</button>
                <button onclick="setTermMode('analyze')" id="tab-analyze" class="flex-1 py-2 font-bold text-neo-green border-l-3 border-neo-white hover:bg-neo-white hover:text-neo-black transition-colors">ANALYZE</button>
            </div>
            <div id="term-output" class="flex-1 p-6 overflow-y-auto font-mono text-neo-green text-sm space-y-3 leading-relaxed scrollbar-none">
                <div class="text-neo-white">AI SYSTEM ONLINE. WAITING FOR INPUT...</div>
            </div>
            <div class="p-4 border-t-3 border-neo-white bg-neo-black flex text-neo-green font-mono items-center">
                <span id="term-prompt" class="mr-2 font-bold">></span>
                <input type="text" id="term-input" class="bg-transparent border-none outline-none flex-1 text-neo-green font-bold text-lg uppercase" placeholder="COMMAND..." autocomplete="off">
            </div>
        </div>
    </div>

    <script>
        /* --- CONFIG & APIs --- */
        const API_GOOGLE = "https://www.googleapis.com/books/v1/volumes";
        const API_GUTENDEX = "https://gutendex.com/books";
        const API_OPENLIB = "https://openlibrary.org/search.json";
        
        let usersDB = JSON.parse(localStorage.getItem('msmahatha_users')) || {};
        
        /* --- SOUND ENGINE --- */
        const sfx = {
            enabled: true,
            ctx: new (window.AudioContext || window.webkitAudioContext)(),
            play: function(type) {
                if(!this.enabled) return;
                if(this.ctx.state === 'suspended') this.ctx.resume();
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.connect(g); g.connect(this.ctx.destination);
                if(type==='click'){ o.type='square'; o.frequency.setValueAtTime(800, this.ctx.currentTime); g.gain.setValueAtTime(0.1, this.ctx.currentTime); o.start(); o.stop(this.ctx.currentTime+0.05); }
                if(type==='hover'){ o.type='sine'; o.frequency.setValueAtTime(200, this.ctx.currentTime); g.gain.setValueAtTime(0.02, this.ctx.currentTime); o.start(); o.stop(this.ctx.currentTime+0.05); }
            }
        };

        /* --- STATE --- */
        let appState = {
            mode: 'grid',
            query: 'science fiction',
            page: 1,
            isLoading: false,
            user: localStorage.getItem('msmahatha_user') || null,
            stash: JSON.parse(localStorage.getItem('msmahatha_stash')) || [],
            history: JSON.parse(localStorage.getItem('msmahatha_history')) || [],
            viewMode: 'grid',
            termMode: 'console'
        };

        const CATEGORIES = [
            {id: 'science fiction', label: 'SCI-FI'},
            {id: 'fantasy', label: 'FANTASY'},
            {id: 'horror', label: 'HORROR'},
            {id: 'mystery', label: 'MYSTERY'},
            {id: 'history', label: 'HISTORY'},
            {id: 'philosophy', label: 'PHILOSOPHY'},
            {id: 'programming', label: 'CODE'},
            {id: 'science', label: 'RESEARCH'},
            {id: 'adventure', label: 'ADVENTURE'},
            {id: 'biography', label: 'BIO'}
        ];

        /* --- INIT --- */
        function init() {
            renderCategories();
            updateStashCount();
            if(appState.user) document.getElementById('user-status').innerHTML = `<span class="mr-2 text-neo-green">●</span> ${appState.user}`;

            document.getElementById('enter-btn').onclick = enterLibrary;
            document.getElementById('load-more-btn').onclick = () => { appState.page++; fetchFederatedBooks(false); };
            document.getElementById('nav-login-btn').onclick = () => toggleModal('auth-modal', true);
            document.getElementById('settings-btn').onclick = () => toggleModal('settings-modal', true);
            
            document.getElementById('toggle-sound').onclick = (e) => { sfx.enabled = !sfx.enabled; e.target.textContent = sfx.enabled ? "ON" : "OFF"; sfx.play('click'); };
            document.getElementById('toggle-crt').onclick = (e) => { document.body.classList.toggle('crt'); e.target.textContent = document.body.classList.contains('crt') ? "ON" : "OFF"; sfx.play('click'); };
            
            const tt = document.getElementById('term-toggle');
            if(tt) tt.onclick = () => { toggleModal('terminal-window', true); document.getElementById('term-input').focus(); };
            document.getElementById('term-close').onclick = () => toggleModal('terminal-window', false);
            document.getElementById('term-input').addEventListener('keydown', handleTerminalInput);
            
            setTermMode('console');
        }

        function enterLibrary() {
            sfx.play('click'); sfx.ctx.resume();
            document.getElementById('gate-container').classList.add('gate-open');
            document.getElementById('app-view').style.opacity = '1';
            fetchFederatedBooks(true);
        }

        function loadView(view) {
            appState.viewMode = view;
            document.getElementById('book-grid').innerHTML = '';
            document.getElementById('load-more-container').classList.add('hidden');
            if (view === 'grid') fetchFederatedBooks(true);
            else if (view === 'stash') renderLocalBooks(appState.stash, "NO ITEMS STASHED");
            else if (view === 'history') renderLocalBooks(appState.history, "NO READING HISTORY");
        }

        function renderLocalBooks(list, msg) {
            const grid = document.getElementById('book-grid');
            if(!list.length) { grid.innerHTML = `<div class="col-span-full text-center font-bold text-gray-500">${msg}</div>`; return; }
            list.forEach(b => renderBookCard(b, grid));
        }

        /* --- FEDERATED SEARCH --- */
        async function fetchFederatedBooks(reset = false) {
            if(appState.isLoading) return;
            appState.isLoading = true;
            const grid = document.getElementById('book-grid');
            const loader = document.getElementById('initial-loader');
            
            if(reset) {
                appState.page = 1;
                grid.innerHTML = '';
                loader.classList.remove('hidden');
            }

            try {
                const query = appState.query;
                const startIndex = (appState.page - 1) * 20;
                const promises = [];
                
                // 1. Google Books
                promises.push(fetch(`${API_GOOGLE}?q=subject:${encodeURIComponent(query)}&filter=free-ebooks&startIndex=${startIndex}&maxResults=10`).then(r=>r.json()).catch(()=>({})));

                // 2. Gutendex
                promises.push(fetch(`${API_GUTENDEX}?topic=${encodeURIComponent(query)}&page=${appState.page}`).then(r=>r.json()).catch(()=>({})));

                // 3. Open Library
                promises.push(fetch(`https://openlibrary.org/search.json?q=subject:${encodeURIComponent(query)}&page=${appState.page}&limit=10&has_fulltext=true`).then(r=>r.json()).catch(()=>({})));

                const [googleData, gutendexData, openData] = await Promise.all(promises);
                
                let results = [];

                // Normalize Google
                if (googleData.items) {
                    results = results.concat(googleData.items.map(item => ({
                        id: item.id,
                        source: 'GOOGLE',
                        title: item.volumeInfo.title,
                        author: item.volumeInfo.authors ? item.volumeInfo.authors[0] : 'Unknown',
                        cover: item.volumeInfo.imageLinks?.thumbnail?.replace('http:', 'https:'),
                        raw: item
                    })));
                }

                // Normalize Gutendex
                if (gutendexData.results) {
                    results = results.concat(gutendexData.results.map(item => ({
                        id: item.id,
                        source: 'GUTENBERG',
                        title: item.title,
                        author: item.authors[0]?.name || 'Unknown',
                        cover: item.formats['image/jpeg'],
                        raw: item
                    })));
                }

                // Normalize Open Library
                if (openData.docs) {
                    results = results.concat(openData.docs.map(item => ({
                        id: item.key,
                        source: 'OPENLIB',
                        title: item.title,
                        author: item.author_name ? item.author_name[0] : 'Unknown',
                        cover: item.cover_i ? `https://covers.openlibrary.org/b/id/${item.cover_i}-M.jpg` : null,
                        raw: item
                    })));
                }

                results.sort(() => Math.random() - 0.5);

                loader.classList.add('hidden');
                
                if (results.length === 0 && reset) {
                    grid.innerHTML = `<div class="col-span-full text-center font-bold p-10 text-neo-red">NO RESULTS IN ANY ARCHIVE</div>`;
                } else {
                    results.forEach(book => {
                        if(book.cover) renderBookCard(book, grid);
                    });
                    document.getElementById('load-more-container').classList.remove('hidden');
                    document.getElementById('load-more-btn').textContent = "LOAD_MORE_DATA()";
                }

            } catch (e) {
                console.error(e);
                grid.innerHTML = `<div class="col-span-full text-center font-bold text-neo-red p-10">NETWORK ERROR</div>`;
            } finally {
                appState.isLoading = false;
            }
        }

        function renderBookCard(book, container) {
            const el = document.createElement('div');
            el.className = 'book-card bg-neo-white border-3 border-neo-black p-2 flex flex-col cursor-pointer relative group';
            
            let badgeColor = 'bg-gray-300';
            if(book.source === 'GOOGLE') badgeColor = 'bg-neo-blue';
            if(book.source === 'GUTENBERG') badgeColor = 'bg-neo-pink';
            if(book.source === 'OPENLIB') badgeColor = 'bg-neo-green';

            el.onclick = () => attemptOpenReader(book);
            el.onmouseenter = () => sfx.play('hover');

            el.innerHTML = `
                <div class="relative aspect-[2/3] w-full border-b-3 border-neo-black overflow-hidden mb-2 bg-neo-black">
                     <img src="${book.cover}" class="w-full h-full object-cover grayscale group-hover:grayscale-0 transition-all" loading="lazy">
                     <div class="absolute bottom-0 right-0 ${badgeColor} text-neo-black px-2 text-[10px] font-bold border-t-3 border-l-3 border-neo-black">SRC: ${book.source}</div>
                </div>
                <div class="flex-1 flex flex-col justify-between">
                    <h3 class="font-display text-sm leading-tight line-clamp-2 uppercase">${book.title}</h3>
                    <p class="font-mono text-[10px] text-gray-500 mb-2 truncate">${book.author}</p>
                    <button class="w-full bg-neo-yellow border-3 border-neo-black font-bold py-2 hover:bg-neo-pink transition-colors text-sm flex justify-between px-4 items-center">
                        <span>OPEN</span><span>></span>
                    </button>
                </div>
            `;
            container.appendChild(el);
        }

        /* --- UNIVERSAL READER ENGINE --- */
        function attemptOpenReader(book) {
            if (!appState.user) toggleModal('auth-modal', true);
            else openReader(book);
        }

        async function openReader(book) {
            sfx.play('click');
            appState.reader.book = book;
            addToHistory(book);
            
            const modal = document.getElementById('reader-modal');
            document.getElementById('reader-title').textContent = book.title;
            toggleModal('reader-modal', true);
            
            const content = document.getElementById('reader-content');
            content.innerHTML = '<div class="h-full flex items-center justify-center flex-col"><div class="w-10 h-10 border-4 border-black border-t-transparent rounded-full animate-spin mb-4"></div><p class="font-mono font-bold">ACCESSING SOURCE NODE...</p></div>';
            
            updateStashBtn();

            if (book.source === 'GOOGLE') {
                const id = book.id;
                const embedUrl = `https://books.google.com/books?id=${id}&printsec=frontcover&output=embed`;
                content.innerHTML = `<iframe src="${embedUrl}" class="w-full h-full border-none"></iframe>`;
            } 
            else if (book.source === 'GUTENBERG') {
                const formats = book.raw.formats;
                const txtUrl = formats['text/plain'] || formats['text/plain; charset=utf-8'];
                
                if (txtUrl) {
                     const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(txtUrl);
                     fetch(proxy).then(r=>r.text()).then(text => {
                         const clean = text.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');
                         content.innerHTML = `<div class="prose max-w-none p-8 text-justify font-mono text-sm bg-neo-white select-text overflow-y-auto h-full text-neo-black">${clean}</div>`;
                     }).catch(() => {
                         content.innerHTML = `<div class="p-10 text-center font-bold text-neo-red">PROXY FAILED.</div>`;
                     });
                } else {
                    content.innerHTML = `<div class="p-10 text-center font-bold">NO TEXT FORMAT AVAILABLE.</div>`;
                }
            }
            else if (book.source === 'OPENLIB') {
                 const id = book.id.replace('/works/', '');
                 try {
                     const res = await fetch(`https://openlibrary.org${book.id}/editions.json?limit=10`);
                     const data = await res.json();
                     const readable = data.entries.find(e => e.ocaid || e.ia);
                     if(readable) {
                         const iaId = readable.ocaid || readable.ia;
                         content.innerHTML = `<iframe src="https://archive.org/embed/${iaId}&ui=embed" class="w-full h-full border-none"></iframe>`;
                     } else {
                         content.innerHTML = '<div class="p-10 text-center font-bold">NO EMBED FOUND.</div>';
                     }
                 } catch(e) {
                     content.innerHTML = '<div class="p-10 text-center font-bold text-neo-red">CONNECTION ERROR.</div>';
                 }
            }
        }

        function closeReader() { toggleModal('reader-modal', false); }

        /* --- UTILS --- */
        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if(show) { el.classList.remove('hidden'); setTimeout(()=>el.classList.add('active'), 10); }
            else { el.classList.remove('active'); setTimeout(()=>el.classList.add('hidden'), 200); }
            sfx.play('click');
        }

        function setupToggle(id, cb, initial = true) {
            const btn = document.getElementById(id);
            let state = initial;
            btn.onclick = () => {
                state = !state;
                btn.textContent = state ? "ON" : "OFF";
                btn.className = state ? "px-4 py-2 bg-neo-green border-3 border-neo-black" : "px-4 py-2 bg-gray-300 border-3 border-neo-black";
                sfx.play('click'); cb(state);
            };
        }

        function renderCategories() {
            const c = document.getElementById('category-container');
            c.innerHTML = CATEGORIES.map(cat => `
                <button onclick="switchCategory('${cat.id}')" class="px-6 border-r-3 border-neo-black bg-white font-bold whitespace-nowrap hover:bg-neo-black hover:text-white transition-colors">${cat.label}</button>
            `).join('');
        }
        
        function switchCategory(id) {
            appState.query = id;
            loadView('grid');
        }
        
        function updateStashCount() { document.getElementById('stash-count').textContent = appState.stash.length; }
        
        function updateStashBtn() {
            const btn = document.getElementById('stash-btn');
            const book = appState.reader.book;
            const isStashed = appState.stash.some(b => b.id === book.id);
            btn.innerHTML = isStashed ? `<span>♥</span> SAVED` : `<span>♡</span> SAVE`;
            btn.className = isStashed ? "bg-neo-pink border-2 border-neo-black px-3 font-bold text-white" : "bg-neo-white border-2 border-neo-black px-3 font-bold hover:bg-neo-pink";
            btn.onclick = () => {
                if(isStashed) appState.stash = appState.stash.filter(b => b.id !== book.id);
                else appState.stash.push(book);
                localStorage.setItem('msmahatha_stash', JSON.stringify(appState.stash));
                updateStashCount(); updateStashBtn(); sfx.play('click');
            };
        }
        
        function addToHistory(book) {
            appState.history = appState.history.filter(b => b.id !== book.id);
            appState.history.unshift(book);
            localStorage.setItem('msmahatha_history', JSON.stringify(appState.history));
        }

        // Auth & Terminal Handlers
        function handleAuth() {
             const u = document.getElementById('auth-username').value;
             if(u) {
                 appState.user = u.toUpperCase();
                 localStorage.setItem('msmahatha_user', appState.user);
                 document.getElementById('user-status').innerHTML = `<span class="mr-2 text-neo-green">●</span> ${appState.user}`;
                 toggleModal('auth-modal', false);
             }
        }
        function closeAuth() { toggleModal('auth-modal', false); }
        
        function setTermMode(mode) {
            appState.termMode = mode;
            const input = document.getElementById('term-input');
            const prompt = document.getElementById('term-prompt');
            ['console', 'search', 'analyze'].forEach(m => {
                const btn = document.getElementById(`tab-${m}`);
                if(m===mode) btn.className = "flex-1 py-2 font-bold text-neo-black bg-neo-green transition-colors";
                else btn.className = "flex-1 py-2 font-bold text-neo-green border-l-3 border-neo-white hover:bg-neo-white hover:text-neo-black transition-colors";
            });
            input.placeholder = mode === 'search' ? 'SEARCH BOOKS...' : (mode === 'analyze' ? 'ENTER BOOK TITLE...' : 'ENTER COMMAND...');
            input.focus();
        }

        async function handleTerminalInput(e) {
             if (e.key !== 'Enter') return;
             const val = e.target.value.trim(); 
             const out = document.getElementById('term-output'); 
             e.target.value = '';
             
             out.innerHTML += `<div class="text-neo-green font-bold mt-2">> ${val}</div>`;
             
             if (appState.termMode === 'search') {
                 toggleModal('terminal-window', false);
                 appState.query = val;
                 loadView('grid');
                 return;
             }
             if (val === 'clear') { out.innerHTML = ''; return; }
             out.innerHTML += `<div class="text-neo-white mb-4">UNKNOWN COMMAND.</div>`;
             out.scrollTop = out.scrollHeight;
        }

        function fillInput(t) { document.getElementById('term-input').value = t; document.getElementById('term-input').focus(); }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>